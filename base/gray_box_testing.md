# AI辅助进行灰盒测试

## 什么是灰盒测试？

###  黑盒 vs 灰盒 vs 白盒

| 维度 | 黑盒测试 | 灰盒测试 | 白盒测试 |
|------|--------|--------|--------|
| **是否了解内部实现** | ❌ 完全不了解 | ✅ 部分了解（如流程、规则、结构） | ✅ 完全了解（阅读全部源码） |
| **测试入口** | 外部接口（API/UI） | 外部接口（API/UI） | 内部函数/模块（如单元测试） |
| **测试目标** | 功能正确性、用户体验 | 功能+逻辑覆盖、集成行为 | 代码路径、分支、语句覆盖 |
| **典型角色** | 业务测试、QA | 高级测试工程师、SDET | 开发、单元测试工程师 |
| **工具示例** | Postman, Selenium | Postman + 代码阅读 + 数据构造 | JUnit, pytest, 覆盖率工具 |

#### 灰盒测试的定义

**灰盒测试（Gray-box Testing）** 是一种介于黑盒测试与白盒测试之间的测试方法。  

测试人员**部分了解系统的内部结构、逻辑或实现机制**，但 **测试执行仍通过外部接口（如 API、UI）进行**，不直接调用内部函数或修改代码。

> ✅ 简单说：**“知道系统怎么工作，但依然像用户一样使用它”**。


## 如何做灰盒测试？

**灰盒测试** 是一个封存在记忆里的概念，已经较少被测试工程师提及了，那我为什么会重提这个概念，因为在最近的项目测试中我有使用。


### 项目背景

我最近在测试一个API，这个API的入参和出参也都很简单。

**示例**

* Request

```shell
POST /api/v1/carrier/detect HTTP/1.1
Host: api.logistics.example.com
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.xxxxx
Content-Type: application/json
{
  "tracking_number": "SF123456789CN"
}
```

* Response

```json
HTTP/1.1 200 OK
Content-Type: application/json

{
  "code": 200,
  "message": "success",
  "data": {
    "tracking_number": "SF123456789CN",
    "carriers": [
      {
        "carrier_code": "SF",
        "carrier_name": "顺丰速运",
      },
      {
        "carrier_code": "SF_EXPRESS",
        "carrier_name": "顺丰快递",
      }
    ]
  }
}
```

这是一个运输商单号识别的接口，通过传入一个单号，识别是哪个运输商。但是内部处理逻辑较为复杂。

1. 先根据用户配置规则识别。
2. 再根据公共识别库识别。
3. 再通过AI识别。
4. 最后根据用户配置的常用运输商排序。

主要识别逻辑是上面的过程，里面还有很多细节的代码。初次拿到需求的时候，我不知道应该怎么测试，或者说我不知道输入什么样的单号，返回什么运输商，以及内部是通过哪个规则识别的。

### AI协助阅读代码逻辑

当我拿到项目代码之后，尝试去阅读API代码。从过往的开发经验来看，我和同事开发一个项目，想要阅读他的代码总是要花费一些时间。如果涉及到你不熟悉的编程语言，这个过程会比较痛苦，甚至你无法完成。

但是，通过AI加持这个过程就会顺畅很多。

📌 首先，我会提问，我正在测试`/api/v1/xxx` 接口，请帮我梳理完整的调用联调。


![](images/ai-read-code1.png)


📌 然后，按照AI梳理的模块一步步阅读代码调用逻辑。

> 1. 你一定要理解业务背景。
> 2. 你必须具备一定的阅读代码的能力。

![](images/ai-read-code2.png)


📌 最后，在阅读代码的过程中会遇到一些复杂的计算函数。这些函数不经过实际运行，很难通过阅读代码计算出结果。此时，我会问：`UserNameBase64Encode()`函数传入"tom"会返回什么？我们甚至不需要安装该编程语言的开发和运行环境。

![](images/ai-read-code3.png)


## 灰盒测试的应用

⚡灰盒测试对测试工程师要求必须具备一定的编程基础。虽然AI可以协助我们降低代码的阅读难度，但仍然需要测试工程师能够读懂编程语言的基本语法。


❌ 不太适合：
- 纯 UI 层简单交互（如表单提交）
- 第三方黑盒系统（无内部信息）
- 纯合规性或用户体验测试

✅ 特别适合以下情况：
- 系统逻辑复杂，但接口简单（输入少、输出少）
- 需要验证集成行为（如多服务协作、规则引擎、状态流转）
- 黑盒测试难以覆盖边界或异常路径
- 测试团队具备一定开发能力或可访问代码/设计文档
- 敏捷或 DevOps 环境中，测试需深度协同开发

### 场景示例

1. **基于数据流的测试（Data Flow Testing）**
- 了解数据在系统中的流转路径（如：用户输入 → 规则引擎 → 数据库 → 返回结果）
- 构造能触发特定数据路径的数据组合

> 📌 应用：你的运输商识别链路（用户规则 → 公共库 → AI → 排序）就是典型数据流。


2. **状态/流程驱动测试（State/Workflow-based Testing）**
- 了解系统状态机或处理流程（如：订单状态从“待支付”→“已发货”）
- 设计用例覆盖状态转换的关键节点和异常中断点

> 📌 应用：测试退款流程时，知道系统依赖“支付成功”状态才允许退款，于是构造未支付订单尝试退款。

3. **配置/规则感知测试（Configuration-aware Testing）**
- 了解系统依赖的配置项、规则表、权重策略等
- 通过修改配置（而非代码）来验证不同行为

> 📌 应用：你提到“用户配置的常用运输商排序”，于是通过切换用户配置，验证返回列表顺序是否变化。

4. **异常路径注入测试（Exception Path Testing）**
- 了解哪些内部条件会触发异常分支（如缓存失效、第三方超时）
- 构造条件使系统走异常路径（如 mock 第三方返回错误，但通过 API 调用触发）

> 📌 应用：知道 AI 识别服务超时会 fallback 到公共库，于是通过网络延迟或 mock 手段模拟超时，验证 fallback 是否生效。

5. **边界与组合测试（Boundary & Combination Testing with Internal Insight）**
- 基于内部逻辑识别真正的边界条件（而非仅靠接口文档）
- 例如：知道某个字段在内部被截断为 50 字符，于是构造 49/50/51 字符测试


## 总结

目前，我的测试团队整体技术能力较弱。我正在推动团队从纯黑盒测试向灰盒测试发展，已经初显成效。测试工程师的能力是一方面，大家的智商、学习能力都是比较接近的，很多时候其实是缺乏一个引路人。随着AI技术的普及，对测试工程师的帮助是全方位的。我们可以利用AI大大降低使用门槛，针对过往那些高大上的技术。

